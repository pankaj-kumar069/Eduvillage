<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>EduVillage | Teacher Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family: Arial, sans-serif;}
body{display:flex;height:100vh;background: linear-gradient(135deg, #6e45e2, #88d3ce);}
.sidebar{width:240px;background:#472e9f;color:white;padding:20px;}
.sidebar h2{text-align:center;margin-bottom:30px;font-family:"Lucida Handwriting";}
.sidebar button{width:100%;padding:12px;margin:6px 0;border:none;background:#755dca;color:black;cursor:pointer;text-align:left;border-radius:5px;transition:0.3s;}
.sidebar button:hover{background:#2a165f;color:white;}
.main{flex:1;padding:30px;overflow-y:auto;}
.section{display:none;background:linear-gradient(135deg,#baa9c5,#88d3ce);padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,0.2);}
.section.active{display:block;}
input, textarea, select{width:100%;padding:10px;margin:8px 0;border-radius:5px;border:1px solid #444;}
button.action{padding:8px 15px;background:#755dca;border:none;border-radius:5px;cursor:pointer;}
button.action:hover{background:#2a165f;color:white;}
h3{margin-bottom:10px;}
li{margin:5px 0;}
</style>
</head>
<body>

<div class="sidebar">
    <h2>EduVillage</h2>
    <button onclick="showSection('profile')">Profile</button>
    <button onclick="showSection('courses')">Manage Courses</button>
    <button onclick="showSection('assignment')">Create Assignment</button>
    <button onclick="showSection('notes')">Upload Notes</button>
    <button onclick="openStudents()">View Students</button>
    <button onclick="openLeaderboard()">Leaderboard</button>
    <button onclick="logout()">Logout</button>
</div>

<div class="main">
    <div id="profile" class="section active">
        <h3>Teacher Profile</h3>
        <p><b>Name:</b> <span id="teacherName"></span></p>
        <p><b>Email:</b> <span id="teacherEmail"></span></p>
    </div>

    <div id="courses" class="section">
        <h3>Manage Courses</h3>
        <input type="text" id="courseName" placeholder="Course Name">
        <button id="addCourseBtn" class="action" onclick="addCourse()">Add Course</button>
    </div>

    <div id="assignment" class="section">
        <h3>Create Assignment</h3>
        <input type="text" id="assignmentTitle" placeholder="Assignment Title">
        <textarea id="assignmentDesc" placeholder="Assignment Description"></textarea>
        <input type="text" id="assignmentCourse" placeholder="Course Name">
        <button class="action" onclick="createAssignment()">Create Assignment</button>
    </div>

    <div id="notes" class="section">
        <h3>Upload Notes</h3>
        <select id="notesCourse"></select>
        <textarea id="notesText" rows="4" placeholder="Enter notes content"></textarea>
        <button class="action" onclick="saveNotes()">Save Notes</button>
    </div>

    <!-- âœ… STUDENTS SECTION FIXED -->
    <div id="students" class="section">
        <h3>Students List</h3>

        <select id="studentCourseSelect" onchange="loadStudentsByCourse()">
            <option value="">Select Course</option>
        </select>

        <ul id="studentList"></ul>
    </div>

    <div id="leaderboard" class="section">
        <h3>Course Leaderboard</h3>
        <ul id="leaderboardList"></ul>
    </div>

</div>

<script>
// ---------- SECTION SWITCH ----------
function showSection(id){
    document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

// ---------- PROFILE ----------
document.getElementById("teacherName").innerText = localStorage.getItem("teacherName") || "Teacher";
document.getElementById("teacherEmail").innerText = localStorage.getItem("teacherEmail") || "Not Available";

// ---------- ADD COURSE ----------
async function addCourse() {
    const name = document.getElementById("courseName").value.trim();
    const teacherId = localStorage.getItem("teacherId");

    if (!name) return alert("Enter course name");

    const res = await fetch("http://localhost:3000/course/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ course_name: name, teacher_id: teacherId })
    });

    const data = await res.json();
    alert(data.message || (data.success ? "Course added" : "Error"));
}

// ---------- LOAD COURSES INTO NOTES DROPDOWN ----------
async function loadNotesCourses() {
    const teacherId = localStorage.getItem("teacherId");
    const dropdown = document.getElementById("notesCourse");

    dropdown.innerHTML = '<option value="">Select Course</option>';

    const res = await fetch(`http://localhost:3000/courses/teacher/${teacherId}`);
    const data = await res.json();

    if (data.success) {
        data.courses.forEach(course => {
            const option = document.createElement("option");
            option.value = course.id;
            option.textContent = course.course_name;
            dropdown.appendChild(option);
        });
    }
}

// ---------- SAVE NOTES ----------
async function saveNotes() {
    const content = document.getElementById("notesText").value.trim();
    const courseId = document.getElementById("notesCourse").value;
    const teacherId = localStorage.getItem("teacherId");

    if (!courseId || !content) return alert("Fill all fields");

    const res = await fetch("http://localhost:3000/notes", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ teacher_id: teacherId, course_id: courseId, content })
    });

    const data = await res.json();
    alert(data.message);
    if (data.success) document.getElementById("notesText").value = "";
}

// ---------- LOAD STUDENT COURSES DROPDOWN ----------
async function loadStudentCourseDropdown() {
    const teacherId = localStorage.getItem("teacherId");
    const dropdown = document.getElementById("studentCourseSelect");

    dropdown.innerHTML = '<option value="">Select Course</option>';

    const res = await fetch(`http://localhost:3000/courses/teacher/${teacherId}`);
    const data = await res.json();

    if (data.success) {
        data.courses.forEach(course => {
            const option = document.createElement("option");
            option.value = course.id;
            option.textContent = course.course_name;
            dropdown.appendChild(option);
        });
    }
}

// ---------- LOAD STUDENTS BY COURSE ----------
async function loadStudentsByCourse() {
    const courseId = document.getElementById("studentCourseSelect").value;
    const ul = document.getElementById("studentList");

    ul.innerHTML = "<li>Loading students...</li>";
    if (!courseId) return ul.innerHTML = "<li>Select a course</li>";

    const res = await fetch(`http://localhost:3000/teacher/students/${courseId}`);
    const data = await res.json();

    ul.innerHTML = "";

    if (data.success && data.students.length > 0) {
        data.students.forEach(s => {
            const li = document.createElement("li");
            li.textContent = `${s.name} â€“ ${s.email}`;
            ul.appendChild(li);
        });
    } else {
        ul.innerHTML = "<li>No students enrolled</li>";
    }
}
async function openLeaderboard() {
    showSection('leaderboard');

    const teacherId = localStorage.getItem("teacherId");
    const ul = document.getElementById("leaderboardList");
    ul.innerHTML = "<li>Loading leaderboard...</li>";

    // get teacher course
    const resCourse = await fetch(`http://localhost:3000/courses/teacher/${teacherId}`);
    const dataCourse = await resCourse.json();

    if (!dataCourse.success || dataCourse.courses.length === 0) {
        ul.innerHTML = "<li>No course found</li>";
        return;
    }

    const courseId = dataCourse.courses[0].id;

    // get leaderboard
    const res = await fetch(`http://localhost:3000/leaderboard/${courseId}`);
    const data = await res.json();

    ul.innerHTML = "";

    if (data.success && data.leaderboard.length > 0) {
        data.leaderboard.forEach((s, index) => {
            const li = document.createElement("li");

            let trophy = "";
            if (index === 0) trophy = "ðŸ¥‡ ";
            else if (index === 1) trophy = "ðŸ¥ˆ ";
            else if (index === 2) trophy = "ðŸ¥‰ ";

            li.innerHTML = `
                ${trophy}<b>#${index + 1}</b> 
                ${s.name} (${s.email}) â€” 
                <b>${s.marks} Marks</b>
            `;

            ul.appendChild(li);
        });
    } else {
        ul.innerHTML = "<li>No scores available</li>";
    }
}



function openStudents(){
    showSection('students');
    loadStudentCourseDropdown();
}

// ---------- LOGOUT ----------
function logout(){
    localStorage.clear();
    window.location.href = "login_register.html";
}

// ---------- INIT ----------
window.addEventListener("DOMContentLoaded", () => {
    loadNotesCourses();
});
</script>
</body>
</html>
